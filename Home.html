<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Earn Pro - टास्क्स</title>
  <script type="module" src="./firebase.js"></script>
  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, getDocs, doc, updateDoc, increment, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const taskList = document.getElementById("task-list");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        const tasksSnapshot = await getDocs(collection(db, "tasks"));
        tasksSnapshot.forEach(docSnap => {
          const task = docSnap.data();
          const div = document.createElement("div");
          div.innerHTML = `
            <img src="${task.image}" width="200"><br>
            <b>${task.name}</b><br>
            इनाम: ₹${task.reward}<br>
            <button onclick="completeTask('${docSnap.id}', '${task.link}', ${task.reward})">इंस्टॉल / देखें</button><hr>
          `;
          taskList.appendChild(div);
        });
      }
    });

    window.completeTask = async (taskId, link, reward) => {
      const user = auth.currentUser;
      if (!user) return alert("कृपया पहले लॉगिन करें");

      // Reward user
      const userRef = doc(db, "users", user.uid);
      await updateDoc(userRef, {
        balance: increment(reward)
      });

      // Track Task click
      await addDoc(collection(db, "activity"), {
        uid: user.uid,
        taskId,
        timestamp: Date.now(),
        reward
      });

      // Redirect to task link
      window.open(link, "_blank");
    };

    window.logoutUser = async () => {
      await signOut(auth);
      window.location.href = "index.html";
    };
  </script>

  <style>
    body { font-family: Arial; text-align: center; padding: 20px; background: #eef2f3; }
    img { border-radius: 8px; }
    button { padding: 10px; margin: 5px; font-weight: bold; background: #38b000; color: white; border: none; border-radius: 6px; }
    hr { margin: 20px 0; }
    .back-btn { position: fixed; top: 10px; left: 10px; background: #444; color: #fff; padding: 5px 10px; border-radius: 5px; }
    .logout-btn { position: fixed; top: 10px; right: 10px; background: #d00000; color: #fff; padding: 5px 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">← पीछे जाएं</button>
  <button class="logout-btn" onclick="logoutUser()">लॉगआउट</button>
  <h2>टास्क लिस्ट</h2>
  <div id="task-list"></div>
</body>
</html>